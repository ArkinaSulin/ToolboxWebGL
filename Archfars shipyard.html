<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archfar's Shipyard - Spelljammer Ship Component Calculator</title>
    <style>
        :root {
            --primary-blue: #1a2a6c;
            --secondary-blue: #2a4b8d;
            --light-blue: #e8f4fd;
            --medium-blue: #d4e7fa;
            --accent-red: #dc3545;
            --success-green: #28a745;
            --warning-red: #f8d7da;
            --text-dark: #333;
            --text-light: #fff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: var(--text-light);
            padding: 20px;
            text-align: center;
            border-bottom: 4px solid var(--accent-red);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .calculator-section {
            padding: 20px;
        }

        .main-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .main-table th {
            background: var(--primary-blue);
            color: white;
            padding: 10px 5px;
            text-align: center;
            position: relative;
            cursor: help;
        }

        .main-table th:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 100;
            font-size: 0.8rem;
        }

        .main-table td {
            padding: 8px 5px;
            text-align: center;
            border: 1px solid #ddd;
            position: relative;
        }

        .final-row td:not(:first-child):not(:nth-child(2)):not(:nth-child(11)):not(:nth-child(12)) {
            cursor: help;
        }

        .final-row td:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            white-space: pre;
            z-index: 100;
            font-size: 0.8rem;
            font-family: monospace;
            min-width: 200px;
            text-align: center;
        }

        .component-name {
            text-align: left;
            font-weight: bold;
            padding-left: 10px;
        }

        .frame-row, .armor-row {
            background: linear-gradient(to right, var(--light-blue), var(--medium-blue));
            border-left: 4px solid var(--primary-blue);
        }

        .final-row {
            background: linear-gradient(to right, #d4edda, #c3e6cb);
            font-weight: bold;
        }

        .negative-value {
            background-color: var(--warning-red);
        }

        input, select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
        }

        input:invalid {
            border-color: var(--accent-red);
        }

        .panels-container {
            display: grid;
            grid-template-columns: 1fr 1fr 200px;
            gap: 20px;
            margin-top: 20px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .hit-location-panel {
            min-width: 180px;
        }

        .summary-panel, .reference-panel {
            display: flex;
            flex-direction: column;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-label {
            font-weight: bold;
        }

        .summary-spacing {
            margin-top: 10px;
        }

        .summary-title {
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 8px;
            margin-bottom: 8px;
        }

        .hit-table {
            width: 100%;
            border-collapse: collapse;
        }

        .hit-table th, .hit-table td {
            padding: 5px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .hit-table th {
            background: var(--primary-blue);
            color: white;
        }

        .serial-col {
            width: 40px;
        }

        .component-col {
            width: 140px;
        }

        button {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: background 0.3s;
        }

        button:hover {
            background: var(--secondary-blue);
        }

        /* Responsive Design */
        @media (max-width: 1199px) {
            .panels-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .hit-location-panel {
                grid-column: 1 / span 2;
            }
        }

        @media (max-width: 767px) {
            .panels-container {
                grid-template-columns: 1fr;
            }
            
            .main-table {
                font-size: 0.8rem;
            }
            
            .main-table th, .main-table td {
                padding: 5px 2px;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Archfar's Shipyard</h1>
            <div class="subtitle">Spelljammer Ship Component Calculator</div>
        </header>
        
        <section class="calculator-section">
            <table class="main-table">
                <thead>
                    <tr>
                        <th data-tooltip="Ship Components">Components</th>
                        <th data-tooltip="User Input Values">User Input</th>
                        <th data-tooltip="Mass in tons">Mass</th>
                        <th data-tooltip="Hit Points">HP</th>
                        <th data-tooltip="Deck Space in 25ft squares">Deck Space</th>
                        <th data-tooltip="Target Area for hit location">Target Area</th>
                        <th data-tooltip="Cargo capacity in tons">Cargo</th>
                        <th data-tooltip="Speed in hexes">Speed</th>
                        <th data-tooltip="Maneuver Class">Maneuver</th>
                        <th data-tooltip="Crew required">Crew</th>
                        <th data-tooltip="Can this component be hit?">Hitable?</th>
                        <th data-tooltip="Effect when hit">On Hit</th>
                        <th data-tooltip="Cost in gold pieces">Cost</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>
            
            <div class="panels-container">
                <div class="panel summary-panel">
                    <h3 class="summary-title">Ship Summary</h3>
                    <div class="summary-spacing"></div>
                    <div class="summary-item">
                        <span class="summary-label">AC:</span>
                        <span id="summary-ac">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Deck Space:</span>
                        <span id="summary-deck">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">HP:</span>
                        <span id="summary-hp">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Damage Threshold:</span>
                        <span id="summary-dt">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Cargo:</span>
                        <span id="summary-cargo">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Speed (Hex):</span>
                        <span id="summary-speed">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Maneuver Class:</span>
                        <span id="summary-maneuver">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Standard Weapon Mount:</span>
                        <span id="summary-std-weapon">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Large Weapon Mount:</span>
                        <span id="summary-large-weapon">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Special:</span>
                        <span id="summary-special">None</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Crew:</span>
                        <span id="summary-crew">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Cost:</span>
                        <span id="summary-cost">-</span>
                    </div>
                </div>
                
                <div class="panel reference-panel">
                    <h3>Reference Ships</h3>
                    <select id="reference-ship-select">
                        <option value="">Select a reference ship...</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                    <div class="summary-item">
                        <span class="summary-label">AC:</span>
                        <span id="ref-ac">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Deck Space:</span>
                        <span id="ref-deck">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">HP:</span>
                        <span id="ref-hp">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Damage Threshold:</span>
                        <span id="ref-dt">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Cargo:</span>
                        <span id="ref-cargo">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Speed (Hex):</span>
                        <span id="ref-speed">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Maneuver Class:</span>
                        <span id="ref-maneuver">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Standard Weapon Mount:</span>
                        <span id="ref-std-weapon">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Large Weapon Mount:</span>
                        <span id="ref-large-weapon">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Special:</span>
                        <span id="ref-special">None</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Crew:</span>
                        <span id="ref-crew">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Cost:</span>
                        <span id="ref-cost">-</span>
                    </div>
                    <button id="load-preset-btn">Load Preset Ship</button>
                </div>
                
                <div class="panel hit-location-panel">
                    <h3>Hit Location Table</h3>
                    <table class="hit-table">
                        <thead>
                            <tr>
                                <th class="serial-col">#</th>
                                <th class="component-col">Component</th>
                            </tr>
                        </thead>
                        <tbody id="hit-table-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Component specifications
        const components = {
            frame: {
                name: "Frame",
                inputType: "dropdown",
                options: ["Tiny", "Small", "Medium", "Large"],
                default: "Small",
                values: {
                    "Tiny": [35, 200, 10, 0, 0, 8, 2, 0, "no", "", 5000],
                    "Small": [55, 250, 30, 0, 0, 9, 2, 0, "no", "", 15000],    // Speed max: 8 → 9
                    "Medium": [80, 350, 50, 0, 0, 7, 3, 0, "no", "", 35000],   // Speed max: 6 → 7
                    "Large": [100, 500, 90, 0, 0, 5, 4, 0, "no", "", 60000]    // Speed max: 4 → 5
                },
                cssClass: "frame-row"
            },
            armor: {
                name: "Armor",
                inputType: "dropdown",
                options: ["Wood", "Plated", "Metal", "Ceramic", "Stone"],
                default: "Wood",
                values: {
                    "Wood": [0, 0, 0, 0, 0, 0, 0, 0, "no", "", 100, 15],
                    "Plated": [-20, 10, 0, 0, 0, 0, 0, 0, "no", "", 250, 17],
                    "Metal": [-40, 20, 0, 0, 0, 0, 0, 0, "no", "", 400, 19],
                    "Ceramic": [-10, 50, 0, 0, 0, 0, 0, 0, "no", "", 300, 13],
                    "Stone": [-50, 0, 0, 0, 0, 0, 0, 0, "no", "", 100, 17]
                },
                cssClass: "armor-row"
            },
            helm: {
                name: "Helm",
                inputType: "number",
                min: 1,
                max: 2,
                default: 1,
                values: [-3, -5, -6, 1, 0, 0, 0, 1, "yes", "Pilot check -10 or lost control", 5000]
            },
            keel: {
                name: "Keel",
                inputType: "readonly",
                default: 1,
                values: [0, 0, 0, 1, 0, 0, 0, 0, "yes", "2x HP Dmg", 0]
            },
            rudder: {
                name: "Rudder",
                inputType: "number",
                min: 1,
                default: 1,
                values: [-4, -10, 0, 1, 0, 0, 1, 1, "yes", "Maneuver -1", 3000]
            },
            sail: {
                name: "Sail",
                inputType: "number",
                min: 1,
                default: 1,
                values: [-4, -10, -2, 1, 0, 1, 0, 0.5, "yes", "Speed -1", 2000]
            },
            cargo: {
                name: "Cargo Hold",
                inputType: "number",
                min: 0,
                default: 0,
                values: [-1, -1, -2, 0.25, 2, 0, 0, 0.2, "yes", "HP -1", 500]
            },
            stdWeapon: {
                name: "Std Weapon Mount",
                inputType: "number",
                min: 0,
                default: 0,
                values: [-4, -10, -4, 1, 0, 0, 0, 1, "yes", "Weapon disabled, Dmg to crew using it", 2000]
            },
            largeWeapon: {
                name: "Large Weapon Mount",
                inputType: "number",
                min: 0,
                default: 0,
                values: [-6, -15, -6, 1, 0, 0, 0, 1, "yes", "Weapon disabled, Dmg to crew using it", 4000]
            },
            hullReinforcement: {
                name: "Hull Reinforcement",
                inputType: "number",
                min: 0,
                default: 0,
                values: [-1, 5, 0, 0, 0, 0, 0, 0, "no", "", 500]
            },
            additionalCrew: {
                name: "Additional Crew",
                inputType: "number",
                min: 0,
                default: 0,
                values: [0, 0, 0, 0, 0, 0, 0, 1, "no", "", 0]
            },
            special: {
                name: "Special",
                inputType: "dropdown",
                options: ["", "Fragile structure -100 HP", "Living treant root reinforces ship +100 HP, act as 10 crew", 
                         "Bombard mount -150 HP +60 Mass", "Scorpion Claws -25 HP +10 Mass", "beholder floating magic -1 maneuver"],
                default: "",
                values: {
                    "": [0, 0, 0, 0, 0, 0, 0, 0, "no", "", 0],
                    "Fragile structure -100 HP": [0, -100, 0, 0, 0, 0, 0, 0, "no", "", 0],
                    "Living treant root reinforces ship +100 HP, act as 10 crew": [0, 100, 0, 0, 0, 0, 0, -10, "no", "", 0],
                    "Bombard mount -150 HP +60 Mass": [-60, -150, 0, 0, 0, 0, 0, 0, "no", "", 0],
                    "Scorpion Claws -25 HP +10 Mass": [-10, -25, 0, 0, 0, 0, 0, 0, "no", "", 0],
                    "beholder floating magic -1 maneuver": [0, 0, 0, 0, 0, 0, -1, 0, "no", "", 0]
                }
            }
        };

        // Reference ships data with ALL UPDATED VALUES
        const referenceShips = {
            "Bombard": {
                frame: "Large",
                armor: "Wood",
                components: {
                    helm: 1,
                    rudder: 3,
                    sail: 4,        // Changed from 2 to 4 (speed fix)
                    cargo: 7,       // Changed from 6 to 7 (cargo fix)
                    stdWeapon: 2,
                    largeWeapon: 0,
                    hullReinforcement: 10,   // Changed from 6 to 10 (HP fix)
                    additionalCrew: 3,       // Changed from 4 to 3 (crew fix)
                    special: "Bombard mount -150 HP +60 Mass"
                },
                preset: {
                    hp: 300,
                    deckSpace: 105,
                    damageThreshold: 20,
                    speed: 4,
                    maneuver: 3,
                    crew: 12,
                    cargo: 15,
                    cost: 120000
                },
                note: "Siege role, carries up to 14 Bombard cannon balls"
            },
            "Damselfly": {
                frame: "Small",
                armor: "Plated",
                components: {
                    helm: 1,
                    rudder: 1,
                    sail: 7,
                    cargo: 2,       // Changed from 3 to 2 (cargo fix)
                    stdWeapon: 1,
                    largeWeapon: 1,
                    hullReinforcement: 7,
                    additionalCrew: 1,       // Changed from 2 to 1 (crew fix)
                    special: ""
                },
                preset: {
                    hp: 200,
                    deckSpace: 24,
                    damageThreshold: 15,
                    speed: 7,
                    maneuver: 2,
                    crew: 10,
                    cargo: 5,
                    cost: 30000
                },
                note: "Scout role"
            },
            "Fast Lamprey": {
                frame: "Medium",
                armor: "Wood",
                components: {
                    helm: 1,
                    rudder: 1,      // Changed from 2 to 1 (MC fix)
                    sail: 5,
                    cargo: 3,
                    stdWeapon: 4,
                    largeWeapon: 1,
                    hullReinforcement: 14,   // Changed from 16 to 14 (HP fix)
                    additionalCrew: 6,       // Changed from 5 to 6 (crew fix)
                    special: ""
                },
                preset: {
                    hp: 300,
                    deckSpace: 31,
                    damageThreshold: 15,
                    speed: 5,
                    maneuver: 3,
                    crew: 16,
                    cargo: 6,
                    cost: 25000
                },
                note: "Upgraded Warship role"
            },
            "Flying Fish": {
                frame: "Medium",
                armor: "Wood",
                components: {
                    helm: 1,
                    rudder: 2,
                    sail: 4,
                    cargo: 20,
                    stdWeapon: 1,
                    largeWeapon: 1,
                    hullReinforcement: 2,
                    additionalCrew: -1,      // Kept -1 (crew fix)
                    special: ""
                },
                preset: {
                    hp: 250,
                    deckSpace: 96,
                    damageThreshold: 15,
                    speed: 4,
                    maneuver: 2,
                    crew: 10,
                    cargo: 40,
                    cost: 20000
                },
                note: "Light Cargo role, Space & Water travel"
            },
            "Hammerhead": {
                frame: "Large",
                armor: "Wood",
                components: {
                    helm: 1,
                    rudder: 3,
                    sail: 4,
                    cargo: 25,
                    stdWeapon: 2,
                    largeWeapon: 1,
                    hullReinforcement: 7,
                    additionalCrew: 2,
                    special: ""
                },
                preset: {
                    hp: 400,
                    deckSpace: 108,
                    damageThreshold: 15,
                    speed: 4,
                    maneuver: 3,
                    crew: 16,
                    cargo: 50,
                    cost: 28000
                },
                note: "Medium Cargo role"
            },
            "Lamprey": {
                frame: "Medium",
                armor: "Wood",
                components: {
                    helm: 1,
                    rudder: 1,      // Changed from 2 to 1 (MC fix)
                    sail: 4,
                    cargo: 3,
                    stdWeapon: 4,
                    largeWeapon: 1,
                    hullReinforcement: 12,   // Changed from 14 to 12 (HP fix)
                    additionalCrew: 6,       // Changed from 5 to 6 (crew fix)
                    special: ""
                },
                preset: {
                    hp: 300,
                    deckSpace: 31,
                    damageThreshold: 15,
                    speed: 4,
                    maneuver: 3,
                    crew: 16,
                    cargo: 6,
                    cost: 22000
                },
                note: "Old Warship role"
            },
            "Living Ship": {
                frame: "Large",
                armor: "Wood",
                components: {
                    helm: 1,
                    rudder: 3,
                    sail: 4,
                    cargo: 25,
                    stdWeapon: 2,
                    largeWeapon: 2,
                    hullReinforcement: 10,
                    additionalCrew: 1,       // Changed from -9 to 1 (crew fix)
                    special: "Living treant root reinforces ship +100 HP, act as 10 crew"
                },
                preset: {
                    hp: 500,
                    deckSpace: 65,
                    damageThreshold: 15,
                    speed: 4,
                    maneuver: 3,
                    crew: 6,
                    cargo: 50,
                    cost: 100000
                },
                note: "Requires adventurous Treant, Living tree requires 2.5 ton of water from cargo per week, Regenerate 2d8/rd while onboard water available"
            },
            "Nautiloid": {
                frame: "Large",
                armor: "Wood",
                components: {
                    helm: 1,
                    rudder: 3,
                    sail: 4,
                    cargo: 8,       // Changed from 7 to 8 (cargo fix)
                    stdWeapon: 3,
                    largeWeapon: 3,
                    hullReinforcement: 10,
                    additionalCrew: 6,       // Changed from 7 to 6 (crew fix)
                    special: ""
                },
                preset: {
                    hp: 400,
                    deckSpace: 100,
                    damageThreshold: 15,
                    speed: 4,
                    maneuver: 3,
                    crew: 20,
                    cargo: 17,
                    cost: 0
                },
                note: "Mind flayers role, Space & Plane travel"
            },
            "Nightspider": {
                frame: "Large",
                armor: "Plated",
                components: {
                    helm: 1,
                    rudder: 3,
                    sail: 3,
                    cargo: 25,
                    stdWeapon: 2,
                    largeWeapon: 3,
                    hullReinforcement: 1,
                    additionalCrew: 10,      // Changed from 11 to 10 (crew fix)
                    special: "Fragile structure -100 HP"
                },
                preset: {
                    hp: 300,
                    deckSpace: 80,
                    damageThreshold: 15,
                    speed: 3,
                    maneuver: 3,
                    crew: 26,
                    cargo: 50,
                    cost: 0
                },
                note: "Sneaker, Neogi role, Low visibility -> first round surprise + double speed"
            },
            "Scorpion Ship": {
                frame: "Small",
                armor: "Metal",
                components: {
                    helm: 1,
                    rudder: 1,
                    sail: 3,
                    cargo: 6,
                    stdWeapon: 1,
                    largeWeapon: 1,
                    hullReinforcement: 10,
                    additionalCrew: 5,
                    special: "Scorpion Claws -25 HP +10 Mass"
                },
                preset: {
                    hp: 250,
                    deckSpace: 10,
                    damageThreshold: 15,
                    speed: 3,
                    maneuver: 2,    // Changed from 3 to 2 (MC fix)
                    crew: 12,
                    cargo: 12,
                    cost: 40000
                },
                note: "Heavy Melee role, Land & Space travel"
            },
            "Shrike Ship": {
                frame: "Medium",
                armor: "Wood",
                components: {
                    helm: 1,
                    rudder: 2,      // Changed from 3 to 2 (MC fix)
                    sail: 7,
                    cargo: 10,
                    stdWeapon: 1,
                    largeWeapon: 2,
                    hullReinforcement: 0,    // Changed from 1 to 0 (HP fix)
                    additionalCrew: 0,       // Changed from -1 to 0 (crew fix)
                    special: ""
                },
                preset: {
                    hp: 200,
                    deckSpace: 49,
                    damageThreshold: 15,
                    speed: 7,
                    maneuver: 2,
                    crew: 12,
                    cargo: 20,
                    cost: 30000
                },
                note: "Flanker role"
            },
            "Space Galleon": {
                frame: "Large",
                armor: "Wood",
                components: {
                    helm: 1,
                    rudder: 3,
                    sail: 3,
                    cargo: 37,      // Changed from 38 to 37 (cargo fix)
                    stdWeapon: 2,
                    largeWeapon: 1,
                    hullReinforcement: 7,
                    additionalCrew: 4,
                    special: ""
                },
                preset: {
                    hp: 400,
                    deckSpace: 122,
                    damageThreshold: 15,
                    speed: 3,
                    maneuver: 3,
                    crew: 20,
                    cargo: 75,
                    cost: 30000
                },
                note: "Heavy Cargo role"
            },
            "Squid Ship": {
                frame: "Medium",
                armor: "Wood",
                components: {
                    helm: 1,
                    rudder: 1,
                    sail: 3,
                    cargo: 25,
                    stdWeapon: 2,
                    largeWeapon: 1,
                    hullReinforcement: 11,
                    additionalCrew: 2,       // Changed from 3 to 2 (crew fix)
                    special: ""
                },
                preset: {
                    hp: 300,
                    deckSpace: 42,
                    damageThreshold: 15,
                    speed: 3,
                    maneuver: 3,
                    crew: 14,
                    cargo: 50,
                    cost: 18000
                },
                note: "Old Cargo ship role"
            },
            "Star Moth": {
                frame: "Medium",
                armor: "Ceramic",
                components: {
                    helm: 1,
                    rudder: 2,
                    sail: 5,
                    cargo: 15,
                    stdWeapon: 2,
                    largeWeapon: 1,
                    hullReinforcement: 0,
                    additionalCrew: 2,       // Changed from 3 to 2 (crew fix)
                    special: ""
                },
                preset: {
                    hp: 400,
                    deckSpace: 40,
                    damageThreshold: 15,
                    speed: 5,
                    maneuver: 2,
                    crew: 14,
                    cargo: 30,
                    cost: 40000
                },
                note: "Astral Elves role"
            },
            "Turtle Ship": {
                frame: "Large",
                armor: "Metal",
                components: {
                    helm: 1,
                    rudder: 3,
                    sail: 3,
                    cargo: 15,      // Changed from 12 to 15 (cargo fix)
                    stdWeapon: 3,
                    largeWeapon: 0,
                    hullReinforcement: 2,    // Changed from 1 to 2 (HP fix)
                    additionalCrew: 4,       // Changed from 5 to 4 (crew fix)
                    special: ""
                },
                preset: {
                    hp: 500,
                    deckSpace: 27,
                    damageThreshold: 15,
                    speed: 3,
                    maneuver: 3,
                    crew: 16,
                    cargo: 30,
                    cost: 50000
                },
                note: "Submarine role, Space, Underwater & Water travel"
            },
            "Tyrant Ship": {
                frame: "Medium",
                armor: "Stone",
                components: {
                    helm: 1,
                    rudder: 2,      // Changed from 1 to 2 (MC fix)
                    sail: 4,
                    cargo: 10,
                    stdWeapon: 0,
                    largeWeapon: 0,
                    hullReinforcement: 3,
                    additionalCrew: 3,
                    special: "beholder floating magic -1 maneuver"
                },
                preset: {
                    hp: 300,
                    deckSpace: 0,
                    damageThreshold: 20,
                    speed: 4,
                    maneuver: 1,
                    crew: 10,
                    cargo: 20,
                    cost: 20000
                },
                note: "Beholder role"
            },
            "Wasp Ship": {
                frame: "Tiny",
                armor: "Wood",
                components: {
                    helm: 1,
                    rudder: 1,
                    sail: 5,
                    cargo: 5,
                    stdWeapon: 1,
                    largeWeapon: 0,
                    hullReinforcement: 6,    // Changed from 0 to 6 (HP fix)
                    additionalCrew: -1,      // Kept -1 (crew fix)
                    special: ""
                },
                preset: {
                    hp: 150,
                    deckSpace: 30,
                    damageThreshold: 15,
                    speed: 5,
                    maneuver: 2,
                    crew: 6,
                    cargo: 10,
                    cost: 15000
                },
                note: "Shuttle, Yacht role"
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeTable();
            populateReferenceShipSelect();
            setupEventListeners();
            calculateTotals();
        });

        // Initialize the main table with components
        function initializeTable() {
            const tbody = document.querySelector('.main-table tbody');
            tbody.innerHTML = '';

            // Create rows for each component
            Object.keys(components).forEach(componentKey => {
                const component = components[componentKey];
                const row = document.createElement('tr');
                if (component.cssClass) {
                    row.className = component.cssClass;
                }

                // Component name cell
                const nameCell = document.createElement('td');
                nameCell.className = 'component-name';
                nameCell.textContent = component.name;
                row.appendChild(nameCell);

                // User input cell
                const inputCell = document.createElement('td');
                let inputElement;

                if (component.inputType === 'dropdown') {
                    inputElement = document.createElement('select');
                    component.options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option;
                        optionElement.textContent = option;
                        if (option === component.default) {
                            optionElement.selected = true;
                        }
                        inputElement.appendChild(optionElement);
                    });
                } else if (component.inputType === 'number') {
                    inputElement = document.createElement('input');
                    inputElement.type = 'number';
                    inputElement.min = component.min || 0;
                    inputElement.max = component.max || '';
                    inputElement.value = component.default;
                } else if (component.inputType === 'readonly') {
                    inputElement = document.createElement('input');
                    inputElement.type = 'number';
                    inputElement.value = component.default;
                    inputElement.readOnly = true;
                }

                inputElement.dataset.component = componentKey;
                inputElement.addEventListener('change', calculateTotals);
                inputCell.appendChild(inputElement);
                row.appendChild(inputCell);

                // Create cells for each value column (initially empty)
                for (let i = 0; i < 11; i++) {
                    const valueCell = document.createElement('td');
                    valueCell.dataset.component = componentKey;
                    valueCell.dataset.column = i;
                    row.appendChild(valueCell);
                }

                tbody.appendChild(row);
            });

            // Add final row for totals
            const finalRow = document.createElement('tr');
            finalRow.className = 'final-row';
            
            const finalNameCell = document.createElement('td');
            finalNameCell.className = 'component-name';
            finalNameCell.textContent = 'Final Stat';
            finalRow.appendChild(finalNameCell);
            
            // Empty cell for user input
            finalRow.appendChild(document.createElement('td'));
            
            // Create cells for each total value (skip hitable and onHit)
            for (let i = 0; i < 11; i++) {
                const totalCell = document.createElement('td');
                totalCell.id = `total-${i}`;
                
                // Leave hitable and onHit columns blank in final row
                if (i === 8 || i === 9) {
                    totalCell.textContent = '';
                }
                
                finalRow.appendChild(totalCell);
            }
            
            tbody.appendChild(finalRow);
        }

        // Populate the reference ship dropdown
        function populateReferenceShipSelect() {
            const select = document.getElementById('reference-ship-select');
            // Sort ship names alphabetically
            const sortedShipNames = Object.keys(referenceShips).sort();
            sortedShipNames.forEach(shipName => {
                const option = document.createElement('option');
                option.value = shipName;
                option.textContent = shipName;
                select.appendChild(option);
            });
            
            select.addEventListener('change', updateReferenceShipDisplay);
        }

        // Set up event listeners
        function setupEventListeners() {
            document.getElementById('load-preset-btn').addEventListener('click', loadPresetShip);
        }

        // Calculate all totals and update displays
        function calculateTotals() {
            // Get current values from inputs
            const currentValues = {};
            Object.keys(components).forEach(componentKey => {
                const input = document.querySelector(`[data-component="${componentKey}"]`);
                if (input) {
                    if (components[componentKey].inputType === 'dropdown') {
                        currentValues[componentKey] = input.value;
                    } else {
                        currentValues[componentKey] = parseInt(input.value) || 0;
                    }
                }
            });

            // Calculate component values and totals
            const totals = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]; // Mass, HP, Deck, Target, Cargo, Speed, Maneuver, Crew, Hitable, OnHit, Cost
            const calculations = [[], [], [], [], [], [], [], [], [], [], []]; // Store calculation breakdowns for tooltips
            
            const frameType = currentValues.frame;
            const armorType = currentValues.armor;
            const armorValues = components.armor.values[armorType];
            const frameValues = components.frame.values[frameType];
            
            // Apply armor percentages to frame in final calculation only (not in display)
            const armorMassMultiplier = 1 + armorValues[0] / 100;
            const armorHPMultiplier = 1 + armorValues[1] / 100;
            const armorCostMultiplier = armorValues[10] / 100;
            
            // Start with modified frame values (armor applied to frame only)
            calculations[0].push({ component: 'frame', value: frameValues[0] * armorMassMultiplier, displayValue: `${frameValues[0]} × ${armorMassMultiplier.toFixed(1)}` });
            calculations[1].push({ component: 'frame', value: frameValues[1] * armorHPMultiplier, displayValue: `${frameValues[1]} × ${armorHPMultiplier.toFixed(1)}` });
            calculations[2].push({ component: 'frame', value: frameValues[2], displayValue: frameValues[2] });
            calculations[3].push({ component: 'frame', value: frameValues[3], displayValue: frameValues[3] });
            calculations[4].push({ component: 'frame', value: frameValues[4], displayValue: frameValues[4] });
            calculations[5].push({ component: 'frame', value: frameValues[5], displayValue: frameValues[5] });
            calculations[6].push({ component: 'frame', value: frameValues[6], displayValue: frameValues[6] });
            calculations[7].push({ component: 'frame', value: frameValues[7], displayValue: frameValues[7] });
            calculations[10].push({ component: 'frame', value: frameValues[10] * armorCostMultiplier, displayValue: `${frameValues[10]} × ${armorCostMultiplier.toFixed(1)}` });

            Object.keys(components).forEach(componentKey => {
                const component = components[componentKey];
                const value = currentValues[componentKey];
                
                // Skip frame (already handled) and armor (only modifies frame, doesn't add separately)
                if (componentKey === 'frame' || componentKey === 'armor') {
                    return;
                }

                let componentValues;
                if (component.inputType === 'dropdown') {
                    componentValues = [...component.values[value]];
                } else {
                    const multiplier = parseInt(value) || 0;
                    componentValues = component.values.map(v => {
                        if (typeof v === 'string') return v;
                        return v * multiplier;
                    });
                }

                // Update component value cells
                for (let i = 0; i < componentValues.length; i++) {
                    const cell = document.querySelector(`[data-component="${componentKey}"][data-column="${i}"]`);
                    if (cell) {
                        let displayValue = componentValues[i];
                        if (typeof displayValue === 'number') {
                            displayValue = Math.round(displayValue);
                        }
                        cell.textContent = displayValue;
                    }
                    
                    // Add to calculations for final totals (except hitable and onHit)
                    if (i < 8 || i === 10) {
                        if (typeof componentValues[i] === 'number' && componentValues[i] !== 0) {
                            calculations[i].push({ 
                                component: componentKey, 
                                value: componentValues[i], 
                                displayValue: componentValues[i] 
                            });
                        }
                    }
                }
            });

            // Update frame and armor display cells (show base values only)
            const frameDisplayValues = components.frame.values[frameType];
            for (let i = 0; i < frameDisplayValues.length; i++) {
                const cell = document.querySelector(`[data-component="frame"][data-column="${i}"]`);
                if (cell) {
                    let displayValue = frameDisplayValues[i];
                    if (typeof displayValue === 'number') {
                        displayValue = Math.round(displayValue);
                    }
                    cell.textContent = displayValue;
                }
            }

            // Update armor display cells (show percentages)
            for (let i = 0; i < armorValues.length; i++) {
                const cell = document.querySelector(`[data-component="armor"][data-column="${i}"]`);
                if (cell) {
                    let displayValue = armorValues[i];
                    if (typeof displayValue === 'number') {
                        if (i === 0 || i === 1 || i === 10) {
                            displayValue = displayValue + '%';
                        } else {
                            displayValue = Math.round(displayValue);
                        }
                    }
                    cell.textContent = displayValue;
                }
            }

            // Calculate totals from calculations
            for (let i = 0; i < calculations.length; i++) {
                if (i !== 8 && i !== 9) { // Skip hitable and onHit
                    totals[i] = calculations[i].reduce((sum, item) => sum + item.value, 0);
                    totals[i] = Math.round(totals[i]);
                }
            }
            
            // Calculate speed based on frame max speed and sail count
            const frameMaxSpeed = frameValues[5];
            const sailCount = currentValues.sail || 0;
            totals[5] = Math.min(frameMaxSpeed, sailCount);
            
            // Calculate maneuver based on frame type and rudder count
            const rudderCount = currentValues.rudder || 0;
            let maneuverExplanation = "";
            if (frameType === 'Tiny' || frameType === 'Small') {
                totals[6] = 2;
                maneuverExplanation = `${frameType} frame + ${rudderCount} rudder(s) = 2`;
            } else if (frameType === 'Medium') {
                totals[6] = rudderCount >= 2 ? 2 : 3;
                maneuverExplanation = `${frameType} frame + ${rudderCount} rudder(s) = ${totals[6]}`;
            } else if (frameType === 'Large') {
                totals[6] = rudderCount >= 3 ? 3 : 4;
                maneuverExplanation = `${frameType} frame + ${rudderCount} rudder(s) = ${totals[6]}`;
            }

            // Update total cells and set tooltips
            for (let i = 0; i < totals.length; i++) {
                const totalCell = document.getElementById(`total-${i}`);
                if (totalCell) {
                    if (i === 8 || i === 9) {
                        totalCell.textContent = ''; // Leave hitable and onHit blank
                        totalCell.removeAttribute('data-tooltip');
                    } else {
                        totalCell.textContent = totals[i];
                        
                        // Apply negative styling only to final row
                        if (totals[i] < 0) {
                            totalCell.classList.add('negative-value');
                        } else {
                            totalCell.classList.remove('negative-value');
                        }
                        
                        // Set tooltip with calculation breakdown
                        if (i === 6) { // Maneuver
                            totalCell.setAttribute('data-tooltip', maneuverExplanation);
                        } else if (i === 7) { // Crew
                            const crewValues = calculations[i].map(item => item.value);
                            const crewSum = crewValues.reduce((sum, val) => sum + val, 0);
                            const crewCalc = calculations[i].map(item => {
                                const val = typeof item.value === 'number' ? item.value.toFixed(1) : item.value;
                                return val;
                            }).filter(val => val !== '0.0');
                            totalCell.setAttribute('data-tooltip', 
                                `${crewCalc.join(' + ')} = ${crewSum.toFixed(1)}\n→ ${Math.round(crewSum)}`);
                        } else {
                            const calc = calculations[i].map(item => item.displayValue);
                            totalCell.setAttribute('data-tooltip', `${calc.join(' ')} = ${totals[i]}`);
                        }
                    }
                }
            }

            // Update ship summary
            updateShipSummary(currentValues, totals);
            
            // Update hit location table
            updateHitLocationTable(currentValues);
        }

        // Update the ship summary panel
        function updateShipSummary(currentValues, totals) {
            const armorType = currentValues.armor;
            const armorAC = components.armor.values[armorType][11];
            
            document.getElementById('summary-ac').textContent = armorAC;
            document.getElementById('summary-deck').textContent = totals[2];
            document.getElementById('summary-hp').textContent = totals[1];
            document.getElementById('summary-dt').textContent = '15'; // Default, would be overridden by preset
            document.getElementById('summary-cargo').textContent = totals[4];
            document.getElementById('summary-speed').textContent = totals[5];
            document.getElementById('summary-maneuver').textContent = totals[6];
            document.getElementById('summary-std-weapon').textContent = currentValues.stdWeapon || 0;
            document.getElementById('summary-large-weapon').textContent = currentValues.largeWeapon || 0;
            
            const specialValue = currentValues.special;
            document.getElementById('summary-special').textContent = specialValue || 'None';
            
            document.getElementById('summary-crew').textContent = totals[7];
            document.getElementById('summary-cost').textContent = totals[10].toLocaleString();
        }

        // Update the hit location table
        function updateHitLocationTable(currentValues) {
            const hitTableBody = document.getElementById('hit-table-body');
            hitTableBody.innerHTML = '';
            
            let serialNumber = 1;
            
            // Add keel (always 1 entry)
            addHitLocationEntry(hitTableBody, serialNumber++, 'Keel');
            
            // Add helm entries
            const helmCount = currentValues.helm || 0;
            for (let i = 0; i < helmCount; i++) {
                addHitLocationEntry(hitTableBody, serialNumber++, 'Helm');
            }
            
            // Add rudder entries
            const rudderCount = currentValues.rudder || 0;
            for (let i = 0; i < rudderCount; i++) {
                addHitLocationEntry(hitTableBody, serialNumber++, 'Rudder');
            }
            
            // Add sail entries
            const sailCount = currentValues.sail || 0;
            for (let i = 0; i < sailCount; i++) {
                addHitLocationEntry(hitTableBody, serialNumber++, 'Sail');
            }
            
            // Add weapon entries
            const stdWeaponCount = currentValues.stdWeapon || 0;
            for (let i = 0; i < stdWeaponCount; i++) {
                addHitLocationEntry(hitTableBody, serialNumber++, 'Std Weapon');
            }
            
            const largeWeaponCount = currentValues.largeWeapon || 0;
            for (let i = 0; i < largeWeaponCount; i++) {
                addHitLocationEntry(hitTableBody, serialNumber++, 'Large Weapon');
            }
            
            // Add cargo entries (count × 0.25, normal rounding)
            const cargoCount = currentValues.cargo || 0;
            const cargoEntries = Math.round(cargoCount * 0.25);
            for (let i = 0; i < cargoEntries; i++) {
                addHitLocationEntry(hitTableBody, serialNumber++, 'Cargo Hold');
            }
        }

        // Helper function to add a hit location entry
        function addHitLocationEntry(tableBody, serial, component) {
            const row = document.createElement('tr');
            
            const serialCell = document.createElement('td');
            serialCell.textContent = serial;
            row.appendChild(serialCell);
            
            const componentCell = document.createElement('td');
            componentCell.textContent = component;
            row.appendChild(componentCell);
            
            tableBody.appendChild(row);
        }

        // Update reference ship display when selected
        function updateReferenceShipDisplay() {
            const shipSelect = document.getElementById('reference-ship-select');
            const shipName = shipSelect.value;
            
            if (!shipName || !referenceShips[shipName]) {
                // Clear display if no ship selected
                ['ac', 'deck', 'hp', 'dt', 'cargo', 'speed', 'maneuver', 'std-weapon', 'large-weapon', 'special', 'crew', 'cost'].forEach(field => {
                    document.getElementById(`ref-${field}`).textContent = '-';
                });
                return;
            }
            
            const ship = referenceShips[shipName];
            const armorAC = components.armor.values[ship.armor][11];
            
            document.getElementById('ref-ac').textContent = armorAC;
            document.getElementById('ref-deck').textContent = ship.preset.deckSpace;
            document.getElementById('ref-hp').textContent = ship.preset.hp;
            document.getElementById('ref-dt').textContent = ship.preset.damageThreshold;
            document.getElementById('ref-cargo').textContent = ship.preset.cargo;
            document.getElementById('ref-speed').textContent = ship.preset.speed;
            document.getElementById('ref-maneuver').textContent = ship.preset.maneuver;
            document.getElementById('ref-std-weapon').textContent = ship.components.stdWeapon;
            document.getElementById('ref-large-weapon').textContent = ship.components.largeWeapon;
            document.getElementById('ref-special').textContent = ship.components.special || 'None';
            document.getElementById('ref-crew').textContent = ship.preset.crew;
            document.getElementById('ref-cost').textContent = ship.preset.cost.toLocaleString();
        }

        // Load preset ship into main table
        function loadPresetShip() {
            const shipSelect = document.getElementById('reference-ship-select');
            const shipName = shipSelect.value;
            
            if (!shipName || !referenceShips[shipName]) {
                alert('Please select a reference ship first.');
                return;
            }
            
            const ship = referenceShips[shipName];
            
            // Set all component values with change events
            Object.keys(ship.components).forEach(componentKey => {
                const input = document.querySelector(`[data-component="${componentKey}"]`);
                if (input) {
                    input.value = ship.components[componentKey];
                    // Trigger change event to ensure calculations update
                    const event = new Event('change', { bubbles: true });
                    input.dispatchEvent(event);
                }
            });
            
            // Set frame and armor with change events
            const frameInput = document.querySelector('[data-component="frame"]');
            const armorInput = document.querySelector('[data-component="armor"]');
            
            frameInput.value = ship.frame;
            armorInput.value = ship.armor;
            
            // Trigger change events to ensure armor percentages are applied
            const changeEvent = new Event('change', { bubbles: true });
            frameInput.dispatchEvent(changeEvent);
            armorInput.dispatchEvent(changeEvent);
            
            // Final recalculation to ensure everything is consistent
            calculateTotals();
        }
    </script>
</body>
</html>